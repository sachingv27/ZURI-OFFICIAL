<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ZURI Partner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Lato', sans-serif; background-color: #FAF5FF; -webkit-tap-highlight-color: transparent; }
        
        /* BRANDING */
        .header-bg { background: linear-gradient(135deg, #4C1D95 0%, #7C3AED 100%); }
        .auth-bg { background: linear-gradient(135deg, #2E1065 0%, #5B21B6 100%); }
        .font-brand { font-family: 'Cinzel', serif; }
        .card-gradient { background: linear-gradient(135deg, #ffffff 0%, #f3e8ff 100%); }
        
        /* UTILS */
        .input-field:focus { border-color: #8B5CF6; box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.1); outline: none; }
        .nav-item.active { color: #6D28D9; }
        .nav-indicator { height: 4px; width: 20px; background-color: #6D28D9; border-radius: 2px; position: absolute; top: 0; display: none; }
        .nav-item.active .nav-indicator { display: block; }
        .due-highlight { border-left: 4px solid #D946EF; background-color: #FDF4FF; border: 1px solid #F0ABFC; box-shadow: 0 4px 6px -1px rgba(217, 70, 239, 0.2); }
        
        /* MODALS */
        .modal-backdrop { background-color: rgba(0,0,0,0.6); backdrop-filter: blur(4px); transition: opacity 0.3s; }
        .hidden-view { display: none !important; }
        .hidden { display: none; }
        
        /* Spinner */
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #7C3AED; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; margin-right: 8px;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Toast */
        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 50px; padding: 16px; position: fixed; z-index: 99; left: 50%; bottom: 120px; transform: translateX(-50%); font-size: 14px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); opacity: 0; transition: opacity 0.3s, bottom 0.3s; }
        #toast.show { visibility: visible; opacity: 1; bottom: 130px; }
    </style>
</head>
<body class="select-none bg-purple-50 h-screen flex flex-col">

    <!-- ================= AUTH VIEW ================= -->
    <div id="authView" class="fixed inset-0 auth-bg z-50 flex flex-col justify-center items-center px-6 text-white hidden-view">
        <div class="w-full max-w-sm py-10">
            <div class="text-center mb-10">
                <h1 class="text-6xl font-brand tracking-widest text-transparent bg-clip-text bg-gradient-to-r from-purple-200 to-pink-200 drop-shadow-sm">ZURI</h1>
                <p class="text-purple-300 text-xs font-bold tracking-[0.5em] mt-2 uppercase">Partner Access</p>
            </div>

            <!-- LOGIN -->
            <div id="loginForm" class="bg-white/10 backdrop-blur-lg border border-white/20 p-8 rounded-3xl shadow-2xl">
                <h2 class="text-2xl font-brand mb-6 text-center">Cloud Login</h2>
                <div class="space-y-4">
                    <input type="tel" id="loginMobile" placeholder="Mobile Number" class="w-full bg-white/20 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-purple-200/50 focus:outline-none focus:bg-white/30 text-lg">
                    <input type="password" id="loginPass" placeholder="Password" class="w-full bg-white/20 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-purple-200/50 focus:outline-none focus:bg-white/30 text-lg">
                    <button id="btnLogin" onclick="window.doLogin()" class="w-full bg-white text-purple-900 font-bold py-3.5 rounded-xl shadow-lg mt-4 hover:bg-purple-50 transition active:scale-95">Login</button>
                </div>
                <div class="mt-6 text-center">
                    <button onclick="window.toggleAuth('register')" class="text-sm font-bold text-white hover:text-pink-300 underline">Create Account</button>
                </div>
            </div>

            <!-- REGISTER -->
            <div id="registerForm" class="hidden bg-white/10 backdrop-blur-lg border border-white/20 p-8 rounded-3xl shadow-2xl">
                <h2 class="text-2xl font-brand mb-6 text-center">Join Zuri</h2>
                <div class="space-y-3">
                    <input type="text" id="regName" placeholder="Your Name" class="w-full bg-white/20 border-white/10 rounded-xl px-4 py-3 text-white focus:bg-white/30">
                    <input type="text" id="regShop" placeholder="Shop Name" class="w-full bg-white/20 border-white/10 rounded-xl px-4 py-3 text-white focus:bg-white/30">
                    <input type="tel" id="regMobile" placeholder="Mobile" class="w-full bg-white/20 border-white/10 rounded-xl px-4 py-3 text-white focus:bg-white/30">
                    <input type="password" id="regPass" placeholder="Password" class="w-full bg-white/20 border-white/10 rounded-xl px-4 py-3 text-white focus:bg-white/30">
                    <button id="btnReg" onclick="window.doRegister()" class="w-full bg-gradient-to-r from-pink-500 to-purple-500 text-white font-bold py-3.5 rounded-xl shadow-lg mt-2">Register</button>
                </div>
                <div class="mt-6 text-center">
                    <button onclick="window.toggleAuth('login')" class="text-sm font-bold text-purple-200 underline">Back to Login</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ================= APP VIEW ================= -->
    <div id="appView" class="flex-1 flex flex-col hidden-view pb-24 relative">
        <div class="header-bg pt-12 pb-8 px-6 rounded-b-[3rem] shadow-2xl relative z-10">
            <div class="flex justify-between items-start">
                <div>
                    <h1 class="text-4xl font-brand text-white tracking-widest">ZURI</h1>
                    <p class="text-purple-200 text-[10px] font-bold tracking-[0.3em] uppercase mt-1">Cloud Partner</p>
                </div>
                <div class="flex flex-col items-end">
                    <span id="displayUser" class="text-white font-bold text-sm mb-1">Hi, User</span>
                    <button onclick="window.openSettings()" class="bg-white/20 hover:bg-white/30 text-white p-2 rounded-full transition shadow-lg backdrop-blur-sm"><i class="fas fa-cog text-sm w-4 h-4 flex items-center justify-center"></i></button>
                </div>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto">
            <!-- DASHBOARD -->
            <div id="tabHome" class="tab-content px-5 mt-6 fade-in">
                <div class="card-gradient rounded-2xl p-5 shadow-md border border-purple-100 mb-5 flex justify-between items-center relative overflow-hidden">
                     <div class="absolute right-0 top-0 text-9xl text-purple-100 opacity-20 -mr-4 -mt-4"><i class="fas fa-chart-line"></i></div>
                    <div><p class="text-xs text-gray-500 font-bold uppercase mb-1">Total Sales</p><h2 class="text-3xl font-brand text-gray-800">₹<span id="dashTotal">0</span></h2></div>
                    <div class="text-right z-10"><p class="text-xs text-gray-500 font-bold uppercase mb-1">Clients</p><h2 class="text-2xl font-bold text-purple-600"><span id="dashCount">0</span></h2></div>
                </div>

                <div class="bg-white rounded-2xl p-6 shadow-md border border-purple-100 mb-5">
                    <h3 class="text-xs font-bold text-gray-400 mb-4 uppercase tracking-wider"><i class="fas fa-crown text-purple-500 mr-2"></i> Client Details</h3>
                    <div class="space-y-4">
                        <input type="text" id="custName" placeholder="Client Name" class="input-field w-full px-4 py-3.5 bg-purple-50/50 border border-gray-200 rounded-xl text-sm font-bold text-gray-700">
                        <input type="tel" id="custMobile" placeholder="Mobile Number" class="input-field w-full px-4 py-3.5 bg-purple-50/50 border border-gray-200 rounded-xl text-sm font-bold text-gray-700 font-mono">
                    </div>
                </div>

                <div class="bg-white rounded-2xl p-6 shadow-md border border-purple-100 mb-5">
                    <h3 class="text-xs font-bold text-gray-400 mb-4 uppercase tracking-wider">Treatments</h3>
                    <div id="serviceList" class="space-y-3"></div>
                </div>

                <div class="bg-white rounded-2xl p-5 shadow-sm border border-purple-200 mb-24 flex justify-between items-center">
                    <span class="text-sm font-bold text-gray-500 uppercase">Total Bill</span>
                    <span class="text-3xl font-brand text-purple-800">₹<span id="totalAmount">0</span></span>
                </div>
            </div>

            <!-- HISTORY -->
            <div id="tabHistory" class="tab-content px-5 mt-6 hidden">
                <div class="flex justify-between items-center mb-5">
                    <h2 class="text-xl font-brand text-gray-800">Client List</h2>
                    <button onclick="window.fetchHistory()" class="text-xs bg-purple-100 text-purple-600 px-3 py-1 rounded-full"><i class="fas fa-sync-alt"></i> Refresh</button>
                </div>
                <div id="historyList" class="space-y-3 pb-10">
                    <div class="text-center text-gray-400 py-10">Loading Cloud Data...</div>
                </div>
            </div>
            
            <!-- INVITE -->
            <div id="tabReminder" class="tab-content px-5 mt-6 hidden">
                <div class="bg-gradient-to-br from-purple-50 to-pink-50 border border-purple-100 rounded-2xl p-6 mb-6 text-center shadow-sm">
                    <h2 class="text-xl font-brand text-gray-800">Magic Invite</h2>
                    <p class="text-xs text-gray-500 mt-2">Re-engage clients instantly.</p>
                </div>
                <div class="bg-white rounded-2xl p-6 shadow-md border border-purple-100 mb-6">
                    <input type="tel" id="remMobile" placeholder="Mobile Number" class="input-field w-full px-4 py-3.5 bg-purple-50/50 border border-gray-200 rounded-xl text-sm font-bold text-gray-700 font-mono">
                </div>
                <button onclick="window.sendQuickReminder()" class="w-full bg-purple-600 active:bg-purple-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-purple-200 flex items-center justify-center space-x-2 text-lg transform transition active:scale-95">
                    <i class="fab fa-paper-plane text-xl"></i><span>Send Invite</span>
                </button>
            </div>
        </div>

        <!-- FAB -->
        <div id="fabContainer" class="fixed bottom-24 left-0 w-full px-5 pointer-events-none z-40">
            <button onclick="window.saveBill()" class="pointer-events-auto w-full bg-gradient-to-r from-purple-600 to-pink-600 active:from-purple-700 active:to-pink-700 text-white font-bold py-4 rounded-xl shadow-xl shadow-purple-200 flex items-center justify-center space-x-2 text-lg transform transition active:scale-95">
                <i class="fab fa-whatsapp text-2xl"></i>
                <span>Save to Cloud & Send</span>
            </button>
        </div>

        <!-- NAV -->
        <div class="fixed bottom-0 left-0 w-full bg-white border-t border-gray-100 pb-safe pt-2 px-6 shadow-[0_-10px_40px_-15px_rgba(0,0,0,0.1)] z-50 h-24 rounded-t-3xl">
            <div class="flex justify-between items-center max-w-md mx-auto pt-2">
                <button onclick="window.showTab('tabHome')" class="nav-item active flex flex-col items-center w-16" id="nav-tabHome"><span class="nav-indicator"></span><i class="fas fa-home text-xl mb-1.5 mt-2"></i><span class="text-[10px] font-bold">Home</span></button>
                <button onclick="window.showTab('tabHistory')" class="nav-item text-gray-400 flex flex-col items-center w-16" id="nav-tabHistory"><span class="nav-indicator"></span><i class="fas fa-address-book text-xl mb-1.5 mt-2"></i><span class="text-[10px] font-bold">Clients</span></button>
                <button onclick="window.showTab('tabReminder')" class="nav-item text-gray-400 flex flex-col items-center w-16" id="nav-tabReminder"><span class="nav-indicator"></span><i class="fas fa-envelope-open-text text-xl mb-1.5 mt-2"></i><span class="text-[10px] font-bold">Invite</span></button>
            </div>
        </div>
    </div>

    <!-- SETTINGS -->
    <div id="settingsSheet" class="fixed inset-0 modal-backdrop z-[60] hidden flex justify-end flex-col">
        <div class="bg-white rounded-t-3xl p-6 shadow-2xl pb-safe">
            <div class="w-12 h-1 bg-gray-200 rounded-full mx-auto mb-6"></div>
            <h2 class="text-xl font-brand text-gray-800 mb-6 px-2">Settings</h2>
            <button onclick="window.doLogout()" class="w-full flex items-center p-4 bg-red-50 border border-red-100 rounded-xl active:bg-red-100 transition"><div class="w-10 h-10 rounded-full bg-white flex items-center justify-center text-red-500 mr-4"><i class="fas fa-sign-out-alt"></i></div><div class="text-left flex-1"><div class="font-bold text-red-600 text-sm">Log Out</div></div></button>
            <button onclick="window.closeSettings()" class="w-full py-4 mt-4 text-gray-400 font-bold text-sm">Close</button>
        </div>
    </div>
    <div id="toast"><i class="fas fa-check-circle text-green-400 mr-2"></i> Success!</div>

    <!-- FIREBASE MODULE -->
    <script type="module">
        // ==========================================
        //  YOUR FIREBASE KEYS ARE EMBEDDED BELOW
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyBxpblrKHQv2KlMallBqCzXai1H4Psnrlg",
            authDomain: "zuri-app-a205a.firebaseapp.com",
            projectId: "zuri-app-a205a",
            storageBucket: "zuri-app-a205a.firebasestorage.app",
            messagingSenderId: "50329823198",
            appId: "1:50329823198:web:920aa99d6467d7a2fd5f4f"
        };

        // --- INIT FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, orderBy, limit } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getAnalytics, logEvent } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics.js";

        let db;
        let app;
        let analytics;
        
        // CHECK CONFIG
        if (Object.keys(firebaseConfig).length === 0) {
            alert("⚠️ ALERT: Please paste your Firebase Keys in the code.");
        } else {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            // Init Analytics (might warn if no measurementId, but safe to run)
            try { analytics = getAnalytics(app); logEvent(analytics, 'app_open'); } catch(e) { console.log("Analytics setup note: " + e.message); }
        }

        // --- GLOBAL STATE ---
        let services = [
            { id: 1, name: 'Haircut', price: 500, selected: false },
            { id: 2, name: 'Facial', price: 1200, selected: false },
            { id: 3, name: 'Manicure', price: 600, selected: false },
            { id: 4, name: 'Pedicure', price: 700, selected: false },
            { id: 5, name: 'Waxing', price: 1500, selected: false }
        ];
        let currentUser = null;

        // --- AUTH LOGIC ---
        window.doRegister = async () => {
            if(!db) return alert("Firebase Config Missing!");
            const name = document.getElementById('regName').value;
            const shop = document.getElementById('regShop').value;
            const mobile = document.getElementById('regMobile').value;
            const pass = document.getElementById('regPass').value;
            
            if(!name || !mobile || !pass) return alert("Fill all fields");

            const btn = document.getElementById('btnReg');
            btn.innerHTML = '<span class="loader"></span> Saving...';

            try {
                // Check exist
                const q = query(collection(db, "partners"), where("mobile", "==", mobile));
                const snap = await getDocs(q);
                if(!snap.empty) {
                    alert("Mobile already registered. Please Login.");
                    btn.innerText = "Register";
                    return;
                }
                // Create
                const docRef = await addDoc(collection(db, "partners"), { name, shop, mobile, pass, joined: new Date() });
                
                if(analytics) logEvent(analytics, 'sign_up', { method: 'mobile' });

                localStorage.setItem('zuri_uid', docRef.id);
                localStorage.setItem('zuri_name', name);
                window.location.reload(); 
            } catch(e) {
                alert("Error: " + e.message);
                btn.innerText = "Register";
            }
        };

        window.doLogin = async () => {
            if(!db) return alert("Firebase Config Missing!");
            const mobile = document.getElementById('loginMobile').value;
            const pass = document.getElementById('loginPass').value;
            const btn = document.getElementById('btnLogin');
            btn.innerHTML = '<span class="loader"></span> Checking...';

            try {
                const q = query(collection(db, "partners"), where("mobile", "==", mobile));
                const snap = await getDocs(q);
                
                if(snap.empty) {
                    alert("Account not found.");
                    btn.innerText = "Login";
                    return;
                }

                let found = false;
                snap.forEach(doc => {
                    if(doc.data().pass === pass) {
                        found = true;
                        localStorage.setItem('zuri_uid', doc.id);
                        localStorage.setItem('zuri_name', doc.data().name);
                        localStorage.setItem('zuri_shop', doc.data().shop);
                        
                        if(analytics) logEvent(analytics, 'login', { method: 'mobile' });
                        
                        checkSession();
                        window.showToast("Login Successful");
                    }
                });

                if(!found) { alert("Wrong Password"); btn.innerText = "Login"; }
            } catch(e) {
                alert("Login Error: " + e.message);
                btn.innerText = "Login";
            }
        };

        window.doLogout = () => {
            if(confirm("Logout from Cloud?")) {
                localStorage.removeItem('zuri_uid');
                window.location.reload();
            }
        };

        // --- DATA LOGIC ---
        window.saveBill = async () => {
            if(!currentUser) return;
            const name = document.getElementById('custName').value;
            const mobile = document.getElementById('custMobile').value;
            const total = document.getElementById('totalAmount').innerText;
            const selected = services.filter(s => s.selected).map(s => s.name).join(', ');

            if(!mobile || total == "0") return alert("Add details & services");

            document.querySelector('#fabContainer button').innerHTML = 'Saving...';

            try {
                // Save to Firestore
                await addDoc(collection(db, "bills"), {
                    partnerId: currentUser.uid,
                    clientName: name || "Client",
                    clientMobile: mobile,
                    amount: parseInt(total),
                    services: selected,
                    date: new Date(),
                    dateStr: new Date().toLocaleDateString('en-GB')
                });

                window.showToast("Saved to Cloud!");
                
                if(analytics) logEvent(analytics, 'purchase', { value: parseInt(total), currency: 'INR' });
                
                // WhatsApp
                const shop = localStorage.getItem('zuri_shop') || "ZURI";
                const msg = `*${shop} Bill* \nName: ${name}\nTotal: ₹${total}\n\nThank you!`;
                window.location.href = `https://api.whatsapp.com/send?phone=91${mobile}&text=${encodeURIComponent(msg)}`;

                // Reset
                document.getElementById('custName').value = '';
                document.getElementById('custMobile').value = '';
                window.renderServices();
                window.fetchHistory(); 

            } catch(e) {
                alert("Save Failed: " + e.message);
            }
            document.querySelector('#fabContainer button').innerHTML = '<i class="fab fa-whatsapp text-2xl"></i> <span>Save to Cloud & Send</span>';
        };

        window.fetchHistory = async () => {
            if(!currentUser || !db) return;
            const list = document.getElementById('historyList');
            const q = query(collection(db, "bills"), where("partnerId", "==", currentUser.uid), orderBy("date", "desc"), limit(20));
            
            try {
                const snap = await getDocs(q);
                list.innerHTML = '';
                let totalSales = 0;
                let count = 0;

                snap.forEach(doc => {
                    const d = doc.data();
                    totalSales += d.amount;
                    count++;
                    const el = document.createElement('div');
                    el.className = "bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center";
                    el.innerHTML = `<div><div class="font-bold text-gray-800">${d.clientName}</div><div class="text-xs text-gray-500">${d.dateStr} • ₹${d.amount}</div></div><div class="text-green-500"><i class="fas fa-check-circle"></i></div>`;
                    list.appendChild(el);
                });

                document.getElementById('dashTotal').innerText = totalSales;
                document.getElementById('dashCount').innerText = count;
                if(snap.empty) list.innerHTML = '<div class="text-center text-gray-400 mt-10">No bills saved yet.</div>';
            } catch(e) { console.error(e); }
        };

        // --- UI HELPERS ---
        window.renderServices = () => {
            const list = document.getElementById('serviceList');
            list.innerHTML = '';
            services.forEach((s, i) => {
                const row = document.createElement('div');
                row.className = `flex justify-between items-center p-3.5 rounded-xl border transition cursor-pointer ${s.selected ? 'bg-purple-50 border-purple-400' : 'bg-white border-gray-100'}`;
                row.onclick = () => { s.selected = !s.selected; window.renderServices(); };
                row.innerHTML = `<div class="flex items-center space-x-3"><div class="w-5 h-5 rounded border flex items-center justify-center ${s.selected?'bg-purple-600 border-purple-600 text-white':'border-gray-300'}">${s.selected?'<i class="fas fa-check text-xs"></i>':''}</div><span class="font-bold text-sm text-gray-700">${s.name}</span></div>${s.selected ? `<input type="number" value="${s.price}" onclick="event.stopPropagation()" oninput="window.updatePrice(${i},this.value)" class="w-16 font-bold text-right text-sm bg-transparent outline-none border-b border-purple-300">` : ''}`;
                list.appendChild(row);
            });
            const total = services.filter(s => s.selected).reduce((a, b) => a + b.price, 0);
            document.getElementById('totalAmount').innerText = total;
        };
        
        window.updatePrice = (i, val) => { services[i].price = parseFloat(val) || 0; window.renderServices(); };
        window.toggleAuth = (v) => { document.getElementById('loginForm').classList.toggle('hidden', v==='register'); document.getElementById('registerForm').classList.toggle('hidden', v==='login'); };
        window.openSettings = () => document.getElementById('settingsSheet').classList.remove('hidden');
        window.closeSettings = () => document.getElementById('settingsSheet').classList.add('hidden');
        window.showTab = (id) => { 
            document.querySelectorAll('.tab-content').forEach(e=>e.classList.add('hidden')); 
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(e=> { e.classList.remove('active', 'text-purple-600'); e.classList.add('text-gray-400'); });
            document.getElementById('nav-'+id).classList.add('active', 'text-purple-600');
            if(id==='tabHistory') window.fetchHistory();
        };
        window.showToast = (m) => { const t = document.getElementById('toast'); t.innerHTML = `<i class="fas fa-check-circle mr-2"></i> ${m}`; t.className = "show"; setTimeout(()=>t.className="", 3000); };
        window.sendQuickReminder = () => {
             const m = document.getElementById('remMobile').value;
             if(m) window.location.href = `https://api.whatsapp.com/send?phone=91${m}&text=Hello! We miss you. Visit us soon!`;
        }

        function checkSession() {
            const uid = localStorage.getItem('zuri_uid');
            if(uid) {
                currentUser = { uid, name: localStorage.getItem('zuri_name') };
                document.getElementById('authView').classList.add('hidden-view');
                document.getElementById('appView').classList.remove('hidden-view');
                document.getElementById('displayUser').innerText = "Hi, " + currentUser.name;
                window.renderServices();
                window.fetchHistory();
            } else {
                document.getElementById('authView').classList.remove('hidden-view');
                document.getElementById('appView').classList.add('hidden-view');
            }
        }

        checkSession();
    </script>
</body>
</html>